{"ast":null,"code":"import { MotionGlobalConfig } from 'motion-utils';\nimport { stepsOrder } from './order.mjs';\nimport { createRenderStep } from './render-step.mjs';\nconst maxElapsed = 40;\n\nfunction createRenderBatcher(scheduleNextBatch, allowKeepAlive) {\n  let runNextFrame = false;\n  let useDefaultElapsed = true;\n  const state = {\n    delta: 0.0,\n    timestamp: 0.0,\n    isProcessing: false\n  };\n\n  const flagRunNextFrame = () => runNextFrame = true;\n\n  const steps = stepsOrder.reduce((acc, key) => {\n    acc[key] = createRenderStep(flagRunNextFrame, allowKeepAlive ? key : undefined);\n    return acc;\n  }, {});\n  const {\n    setup,\n    read,\n    resolveKeyframes,\n    preUpdate,\n    update,\n    preRender,\n    render,\n    postRender\n  } = steps;\n\n  const processBatch = () => {\n    const timestamp = MotionGlobalConfig.useManualTiming ? state.timestamp : performance.now();\n    runNextFrame = false;\n\n    if (!MotionGlobalConfig.useManualTiming) {\n      state.delta = useDefaultElapsed ? 1000 / 60 : Math.max(Math.min(timestamp - state.timestamp, maxElapsed), 1);\n    }\n\n    state.timestamp = timestamp;\n    state.isProcessing = true; // Unrolled render loop for better per-frame performance\n\n    setup.process(state);\n    read.process(state);\n    resolveKeyframes.process(state);\n    preUpdate.process(state);\n    update.process(state);\n    preRender.process(state);\n    render.process(state);\n    postRender.process(state);\n    state.isProcessing = false;\n\n    if (runNextFrame && allowKeepAlive) {\n      useDefaultElapsed = false;\n      scheduleNextBatch(processBatch);\n    }\n  };\n\n  const wake = () => {\n    runNextFrame = true;\n    useDefaultElapsed = true;\n\n    if (!state.isProcessing) {\n      scheduleNextBatch(processBatch);\n    }\n  };\n\n  const schedule = stepsOrder.reduce((acc, key) => {\n    const step = steps[key];\n\n    acc[key] = function (process) {\n      let keepAlive = arguments.length > 1 && arguments[1] !== undefined ? arguments[1] : false;\n      let immediate = arguments.length > 2 && arguments[2] !== undefined ? arguments[2] : false;\n      if (!runNextFrame) wake();\n      return step.schedule(process, keepAlive, immediate);\n    };\n\n    return acc;\n  }, {});\n\n  const cancel = process => {\n    for (let i = 0; i < stepsOrder.length; i++) {\n      steps[stepsOrder[i]].cancel(process);\n    }\n  };\n\n  return {\n    schedule,\n    cancel,\n    state,\n    steps\n  };\n}\n\nexport { createRenderBatcher };","map":{"version":3,"mappings":"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","names":["maxElapsed","scheduleNextBatch","allowKeepAlive","runNextFrame","useDefaultElapsed","state","delta","timestamp","isProcessing","flagRunNextFrame","steps","stepsOrder","reduce","acc","key","createRenderStep","undefined","setup","read","resolveKeyframes","preUpdate","update","preRender","render","postRender","processBatch","MotionGlobalConfig","useManualTiming","performance","now","Math","max","min","process","wake","schedule","step","keepAlive","immediate","cancel","i","length"],"sources":["C:\\Projects\\TVMazee\\node_modules\\motion-dom\\src\\frameloop\\batcher.ts"],"sourcesContent":["import { MotionGlobalConfig } from \"motion-utils\"\nimport { stepsOrder } from \"./order\"\nimport { createRenderStep } from \"./render-step\"\nimport { Batcher, FrameData, Process, Steps } from \"./types\"\n\nconst maxElapsed = 40\n\nexport function createRenderBatcher(\n    scheduleNextBatch: (callback: Function) => void,\n    allowKeepAlive: boolean\n) {\n    let runNextFrame = false\n    let useDefaultElapsed = true\n\n    const state: FrameData = {\n        delta: 0.0,\n        timestamp: 0.0,\n        isProcessing: false,\n    }\n\n    const flagRunNextFrame = () => (runNextFrame = true)\n\n    const steps = stepsOrder.reduce((acc, key) => {\n        acc[key] = createRenderStep(\n            flagRunNextFrame,\n            allowKeepAlive ? key : undefined\n        )\n        return acc\n    }, {} as Steps)\n\n    const {\n        setup,\n        read,\n        resolveKeyframes,\n        preUpdate,\n        update,\n        preRender,\n        render,\n        postRender,\n    } = steps\n\n    const processBatch = () => {\n        const timestamp = MotionGlobalConfig.useManualTiming\n            ? state.timestamp\n            : performance.now()\n        runNextFrame = false\n\n        if (!MotionGlobalConfig.useManualTiming) {\n            state.delta = useDefaultElapsed\n                ? 1000 / 60\n                : Math.max(Math.min(timestamp - state.timestamp, maxElapsed), 1)\n        }\n\n        state.timestamp = timestamp\n        state.isProcessing = true\n\n        // Unrolled render loop for better per-frame performance\n        setup.process(state)\n        read.process(state)\n        resolveKeyframes.process(state)\n        preUpdate.process(state)\n        update.process(state)\n        preRender.process(state)\n        render.process(state)\n        postRender.process(state)\n\n        state.isProcessing = false\n\n        if (runNextFrame && allowKeepAlive) {\n            useDefaultElapsed = false\n            scheduleNextBatch(processBatch)\n        }\n    }\n\n    const wake = () => {\n        runNextFrame = true\n        useDefaultElapsed = true\n\n        if (!state.isProcessing) {\n            scheduleNextBatch(processBatch)\n        }\n    }\n\n    const schedule = stepsOrder.reduce((acc, key) => {\n        const step = steps[key]\n        acc[key] = (process: Process, keepAlive = false, immediate = false) => {\n            if (!runNextFrame) wake()\n\n            return step.schedule(process, keepAlive, immediate)\n        }\n        return acc\n    }, {} as Batcher)\n\n    const cancel = (process: Process) => {\n        for (let i = 0; i < stepsOrder.length; i++) {\n            steps[stepsOrder[i]].cancel(process)\n        }\n    }\n\n    return { schedule, cancel, state, steps }\n}\n"]},"metadata":{},"sourceType":"module"}